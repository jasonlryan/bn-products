<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Redis Compilation - BN Products</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0052a3; }
        button:disabled { 
            background: #ccc; 
            cursor: not-allowed; 
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .result {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .section {
            margin: 30px 0;
            border-top: 2px solid #eee;
            padding-top: 20px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            border-radius: 6px;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-indicator.green { background: #28a745; }
        .status-indicator.red { background: #dc3545; }
        .status-indicator.yellow { background: #ffc107; }
        .status-indicator.gray { background: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Redis Compilation Test Suite</h1>
        
        <p>This page tests the Redis-based compilation system for BN Products.</p>

        <div class="section">
            <h2>üîß Setup & Population</h2>
            <button onclick="checkPopulationStatus()">Check Population Status</button>
            <button onclick="populateRedis()">Populate Redis Data</button>
            <div id="setupResults" class="result"></div>
        </div>

        <div class="section">
            <h2>üöÄ Compilation Tests</h2>
            <div>
                <label for="productSelect">Select Product:</label>
                <select id="productSelect" style="margin: 10px; padding: 5px;">
                    <option value="">Loading products...</option>
                </select>
            </div>
            
            <div style="margin: 15px 0;">
                <button onclick="compileMarketing()">üéØ Compile Marketing</button>
                <button onclick="compileMarketIntel()">üìä Compile Market Intel</button>
                <button onclick="compileProductStrategy()">üéØ Compile Product Strategy</button>
                <button onclick="compileAll()">‚ö° Compile All</button>
            </div>
            
            <div id="compilationResults" class="result"></div>
        </div>

        <div class="section">
            <h2>üìä Compilation Status</h2>
            <button onclick="checkCompilationStatus()">Refresh Status</button>
            <div id="statusGrid" class="grid"></div>
        </div>

        <div class="section">
            <h2>üîç Compiled Content</h2>
            <button onclick="viewCompiledContent('marketing')">View Marketing</button>
            <button onclick="viewCompiledContent('market-intel')">View Market Intel</button>
            <button onclick="viewCompiledContent('product-strategy')">View Product Strategy</button>
            <div id="contentResults" class="result"></div>
        </div>

        <div class="section">
            <h2>üìà System Status</h2>
            <button onclick="showSystemStatus()">Show Redis Status</button>
            <div id="systemResults" class="result"></div>
        </div>
    </div>

    <script>
        let currentProductId = '';
        let products = [];

        // Utility functions
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            return `[${timestamp}] ${prefix} ${message}`;
        }

        function updateResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.textContent += log(message, type) + '\n';
            element.scrollTop = element.scrollHeight;
        }

        function clearResult(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // API call wrapper
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(endpoint, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`HTTP ${response.status}: ${error}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API call failed:', error);
                throw error;
            }
        }

        // Setup & Population
        window.checkPopulationStatus = async function() {
            clearResult('setupResults');
            updateResult('setupResults', 'Checking population status...');
            
            try {
                const status = await apiCall('/api/setup/populate');
                updateResult('setupResults', `Population Status: ${status.isPopulated ? 'POPULATED' : 'EMPTY'}`, 
                    status.isPopulated ? 'success' : 'warning');
                updateResult('setupResults', `Products: ${status.status.products}`);
                updateResult('setupResults', `Settings: ${status.status.hasSettings ? 'EXISTS' : 'MISSING'}`);
                updateResult('setupResults', `Version: ${status.status.version}`);
                
                // Update product list
                products = status.products || [];
                updateProductSelect();
                
            } catch (error) {
                updateResult('setupResults', `Failed to check status: ${error.message}`, 'error');
            }
        };

        window.populateRedis = async function() {
            clearResult('setupResults');
            updateResult('setupResults', 'Populating Redis with sample data...');
            
            try {
                const result = await apiCall('/api/setup/populate', {
                    method: 'POST',
                    body: JSON.stringify({ clearExisting: true })
                });
                
                if (result.success) {
                    updateResult('setupResults', 'Population completed successfully!', 'success');
                    updateResult('setupResults', `Products created: ${result.results.products}`);
                    updateResult('setupResults', `Content files: ${result.results.contentFiles}`);
                    updateResult('setupResults', `Settings: ${result.results.settings}`);
                    
                    // Refresh products
                    await checkPopulationStatus();
                } else {
                    updateResult('setupResults', 'Population completed with errors:', 'warning');
                    result.errors?.forEach(error => {
                        updateResult('setupResults', `  ‚Ä¢ ${error}`, 'error');
                    });
                }
                
            } catch (error) {
                updateResult('setupResults', `Population failed: ${error.message}`, 'error');
            }
        };

        // Product selection
        function updateProductSelect() {
            const select = document.getElementById('productSelect');
            select.innerHTML = '';
            
            if (products.length === 0) {
                select.innerHTML = '<option value="">No products available</option>';
                return;
            }
            
            select.innerHTML = '<option value="">Select a product...</option>';
            products.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (${product.type})`;
                select.appendChild(option);
            });
            
            select.addEventListener('change', (e) => {
                currentProductId = e.target.value;
                if (currentProductId) {
                    updateResult('compilationResults', `Selected product: ${currentProductId}`);
                }
            });
            
            // Auto-select first product
            if (products.length > 0) {
                currentProductId = products[0].id;
                select.value = currentProductId;
            }
        }

        // Compilation functions
        window.compileMarketing = async function() {
            await runCompilation('marketing');
        };

        window.compileMarketIntel = async function() {
            await runCompilation('market-intel');
        };

        window.compileProductStrategy = async function() {
            await runCompilation('product-strategy');
        };

        window.compileAll = async function() {
            if (!currentProductId) {
                updateResult('compilationResults', 'Please select a product first', 'warning');
                return;
            }

            clearResult('compilationResults');
            updateResult('compilationResults', `Starting complete compilation for ${currentProductId}...`);
            
            try {
                // Since we don't have a compile-all endpoint, run them sequentially
                updateResult('compilationResults', 'Compiling Marketing...');
                await runCompilation('marketing', false);
                
                updateResult('compilationResults', 'Compiling Market Intelligence...');
                await runCompilation('market-intel', false);
                
                updateResult('compilationResults', 'Compiling Product Strategy...');
                await runCompilation('product-strategy', false);
                
                updateResult('compilationResults', 'All compilations completed!', 'success');
                
            } catch (error) {
                updateResult('compilationResults', `Compilation failed: ${error.message}`, 'error');
            }
        };

        async function runCompilation(type, clearResults = true) {
            if (!currentProductId) {
                updateResult('compilationResults', 'Please select a product first', 'warning');
                return;
            }

            if (clearResults) clearResult('compilationResults');
            updateResult('compilationResults', `Starting ${type} compilation for ${currentProductId}...`);
            
            try {
                const result = await apiCall(`/api/compilation/${type}`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        productId: currentProductId,
                        content: `Compiled ${type} content for ${currentProductId} at ${new Date().toISOString()}`
                    })
                });
                
                if (result.success) {
                    updateResult('compilationResults', `${type} compilation completed successfully!`, 'success');
                } else {
                    updateResult('compilationResults', `${type} compilation failed: ${result.error}`, 'error');
                }
                
            } catch (error) {
                updateResult('compilationResults', `${type} compilation failed: ${error.message}`, 'error');
            }
        }

        // Status checking
        window.checkCompilationStatus = async function() {
            if (!currentProductId) {
                document.getElementById('statusGrid').innerHTML = '<p>Please select a product first</p>';
                return;
            }

            try {
                const status = await apiCall(`/api/compilation/status?productId=${currentProductId}`);
                
                const statusGrid = document.getElementById('statusGrid');
                statusGrid.innerHTML = `
                    <div class="card">
                        <h3>Marketing</h3>
                        <p><span class="status-indicator ${status.compilations.marketing.exists ? 'green' : 'gray'}"></span>
                        ${status.compilations.marketing.exists ? 'Compiled' : 'Not compiled'}</p>
                        <p>Count: ${status.compilations.marketing.count}</p>
                    </div>
                    <div class="card">
                        <h3>Market Intelligence</h3>
                        <p><span class="status-indicator ${status.compilations.marketIntel.exists ? 'green' : 'gray'}"></span>
                        ${status.compilations.marketIntel.exists ? 'Compiled' : 'Not compiled'}</p>
                        <p>Count: ${status.compilations.marketIntel.count}</p>
                    </div>
                    <div class="card">
                        <h3>Product Strategy</h3>
                        <p><span class="status-indicator ${status.compilations.productStrategy.exists ? 'green' : 'gray'}"></span>
                        ${status.compilations.productStrategy.exists ? 'Compiled' : 'Not compiled'}</p>
                        <p>Count: ${status.compilations.productStrategy.count}</p>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('statusGrid').innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        };

        // Content viewing
        window.viewCompiledContent = async function(type) {
            if (!currentProductId) {
                updateResult('contentResults', 'Please select a product first', 'warning');
                return;
            }

            clearResult('contentResults');
            updateResult('contentResults', `Loading ${type} content for ${currentProductId}...`);
            
            try {
                const content = await apiCall(`/api/compilation/${type}?productId=${currentProductId}`);
                updateResult('contentResults', `${type.toUpperCase()} CONTENT:`, 'success');
                updateResult('contentResults', JSON.stringify(content, null, 2));
                
            } catch (error) {
                if (error.message.includes('404')) {
                    updateResult('contentResults', `No ${type} content found. Please compile first.`, 'warning');
                } else {
                    updateResult('contentResults', `Failed to load ${type} content: ${error.message}`, 'error');
                }
            }
        };

        // System status
        window.showSystemStatus = async function() {
            clearResult('systemResults');
            updateResult('systemResults', 'Checking Redis system status...');
            
            try {
                // Check various Redis keys
                const checks = [
                    { name: 'Population Status', endpoint: '/api/setup/populate' },
                    { name: 'Products API', endpoint: '/api/products' }
                ];
                
                for (const check of checks) {
                    try {
                        const result = await apiCall(check.endpoint);
                        updateResult('systemResults', `${check.name}: OK`, 'success');
                    } catch (error) {
                        updateResult('systemResults', `${check.name}: FAILED - ${error.message}`, 'error');
                    }
                }
                
            } catch (error) {
                updateResult('systemResults', `System check failed: ${error.message}`, 'error');
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üß™ Redis compilation test page loaded');
            checkPopulationStatus();
        });
    </script>
</body>
</html>